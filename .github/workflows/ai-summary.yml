name: AI Summary Report

on:
  schedule:
    # Singapore 08:10 (UTC 00:10)
    - cron: "10 0 * * *"
    # Singapore 22:40 (UTC 14:40)
    - cron: "40 14 * * *"
  workflow_dispatch:

jobs:
  generate_summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install requests pyyaml

      - name: Load TrendRadar Result and Generate AI Summary (DeepSeek)
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          import json, os, requests

          API_KEY = os.environ["DEEPSEEK_API_KEY"]
          BASE_URL = "https://api.deepseek.com/v1/chat/completions"

          data_path = "data/hot_news.json"
          if not os.path.exists(data_path):
              summary = "未找到今日数据，请检查 TrendRadar 是否正常运行。"
          else:
              with open(data_path, "r", encoding="utf-8") as f:
                  news = json.load(f)

              text = ""
              for group in news.get("groups", []):
                  text += f"【{group['name']}】\n"
                  for item in group["items"][:5]:
                      text += f"- {item['title']}\n"
                  text += "\n"

              prompt = (
                  "你是一个趋势新闻总结 AI，请根据以下 TrendRadar 抓取的新闻，生成今日总结。\n\n"
                  "要求：\n"
                  "1. 用通俗中文总结每个板块的趋势\n"
                  "2. 指出今天整体热点方向（AI、手机、社会、财经等）\n"
                  "3. 字数控制在 300~600 字\n\n"
                  "原始数据如下：\n\n"
                  f"{text}"
              )

              payload = {
                  "model": "deepseek-chat",
                  "messages": [
                      {"role": "system", "content": "你是专业新闻编辑和趋势分析 AI。"},
                      {"role": "user", "content": prompt}
                  ]
              }

              headers = {
                  "Content-Type": "application/json",
                  "Authorization": f"Bearer {API_KEY}"
              }

              response = requests.post(BASE_URL, headers=headers, json=payload)
              res = response.json()
              summary = res["choices"][0]["message"]["content"]

          with open("ai_summary.txt", "w", encoding="utf-8") as f:
              f.write(summary)

      - name: Send to WeWork
        env:
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
        run: |
          import requests, json, os

          webhook = os.environ["WEWORK_WEBHOOK_URL"]

          with open("ai_summary.txt", "r", encoding="utf-8") as f:
              content = f.read()

          data = {
              "msgtype": "text",
              "text": {
                  "content": f"【AI 总结报告】\n{content}"
              }
          }

          requests.post(webhook, data=json.dumps(data))
