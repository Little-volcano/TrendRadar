name: AI Summary Report

on:
  schedule:
    # 北京时间 08:10 → UTC 00:10
    - cron: "10 0 * * *"
    # 北京时间 22:40 → UTC 14:40
    - cron: "40 14 * * *"
  workflow_dispatch:

jobs:
  generate_summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install openai requests pyyaml

      - name: Load TrendRadar Result and Generate AI Summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          import json, os, requests
          from openai import OpenAI

          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

          # 读取 TrendRadar 爬虫存储的最新数据
          data_path = "data/hot_news.json"
          if not os.path.exists(data_path):
              summary = "未找到今日数据，请检查 TrendRadar 是否正常运行。"
          else:
              with open(data_path, "r", encoding="utf-8") as f:
                  news = json.load(f)

              # 结构整理
              text = ""
              for group in news.get("groups", []):
                  text += f"【{group['name']}】\n"
                  for item in group["items"][:5]:  # 每组最多取 5 条
                      text += f"- {item['title']}\n"
                  text += "\n"

              prompt = f"""
你是一个新闻编辑助手，请根据以下 TrendRadar 抓取的新闻数据，生成一份高质量的 AI 总结报告。

要求：
1. 结构清晰
2. 每个分类用一段话总结趋势与变化
3. 给出整体的趋势点评（例如：AI 行业、手机行业、政策方向等）
4. 控制在 300~600 字之间

原始数据如下：

{text}
"""

              response = client.chat.completions.create(
                  model="gpt-5.1",
                  messages=[
                      {"role": "system", "content": "你是一名专业的新闻编辑与趋势分析师。"},
                      {"role": "user", "content": prompt}
                  ]
              )

              summary = response.choices[0].message["content"]

          # 保存 AI 总结
          with open("ai_summary.txt", "w", encoding="utf-8") as f:
              f.write(summary)

      - name: Send to WeWork
        env:
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
        run: |
          import requests, json, os

          webhook = os.environ["WEWORK_WEBHOOK_URL"]

          with open("ai_summary.txt", "r", encoding="utf-8") as f:
              content = f.read()

          # 企业微信文本格式
          data = {
              "msgtype": "text",
              "text": {
                  "content": f"【AI 总结报告】\n{content}"
              }
          }

          requests.post(webhook, data=json.dumps(data))
